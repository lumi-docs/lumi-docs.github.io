<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Training on ML engine | Documentation</title>
    <meta name="description" content="Welcome to Lumidigm&#39;s (part of HID Global Corporation) official documentation page.">
    
    
    <link rel="preload" href="/assets/css/0.styles.382af5d5.css" as="style"><link rel="preload" href="/assets/js/app.12f85102.js" as="script"><link rel="preload" href="/assets/js/6.fd7790cd.js" as="script"><link rel="prefetch" href="/assets/js/10.a876fc82.js"><link rel="prefetch" href="/assets/js/2.d8f505d4.js"><link rel="prefetch" href="/assets/js/3.f839fb6e.js"><link rel="prefetch" href="/assets/js/4.8fd39531.js"><link rel="prefetch" href="/assets/js/5.b76c76d5.js"><link rel="prefetch" href="/assets/js/7.64d93997.js"><link rel="prefetch" href="/assets/js/8.e4e54e17.js"><link rel="prefetch" href="/assets/js/9.28e064bf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.382af5d5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Documentation</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/" class="nav-link router-link-active">Docs</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/" class="nav-link router-link-active">Docs</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Google Cloud Platform</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/docs/google_cloud_platform/setting_up_your_console/" class="sidebar-link">Setting up your console</a></li><li><a href="/docs/google_cloud_platform/training_on_ml_engine/" class="active sidebar-link">Training on ML engine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/google_cloud_platform/training_on_ml_engine/#ml-engine" class="sidebar-link">ML engine</a></li><li class="sidebar-sub-header"><a href="/docs/google_cloud_platform/training_on_ml_engine/#install-google-cloud-sdk" class="sidebar-link">Install Google Cloud SDK</a></li><li class="sidebar-sub-header"><a href="/docs/google_cloud_platform/training_on_ml_engine/#make-code-compatible-with-ml-engine" class="sidebar-link">Make code compatible with ML engine</a></li><li class="sidebar-sub-header"><a href="/docs/google_cloud_platform/training_on_ml_engine/#create-a-ml-engine-job" class="sidebar-link">Create a ML engine job</a></li><li class="sidebar-sub-header"><a href="/docs/google_cloud_platform/training_on_ml_engine/#uploading-data-and-code-to-the-cloud" class="sidebar-link">Uploading data and code to the cloud</a></li><li class="sidebar-sub-header"><a href="/docs/google_cloud_platform/training_on_ml_engine/#cloud-shell" class="sidebar-link">Cloud shell</a></li><li class="sidebar-sub-header"><a href="/docs/google_cloud_platform/training_on_ml_engine/#run-your-ml-job" class="sidebar-link">Run your ML job</a></li><li class="sidebar-sub-header"><a href="/docs/google_cloud_platform/training_on_ml_engine/#summary" class="sidebar-link">Summary</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>M Series Data</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Info</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="training-on-ml-engine"><a href="#training-on-ml-engine" aria-hidden="true" class="header-anchor">#</a> Training on ML engine</h1> <p>In this tutorial, we will train a model on the ML engine.</p> <h2 id="ml-engine"><a href="#ml-engine" aria-hidden="true" class="header-anchor">#</a> ML engine</h2> <p>The ML engine is a managed service in GCP used to train and deploy ML models. A <strong>managed service</strong> is a common cloud term. A traditional cloud service requires users to (1) define a job and (2) implement their own solution. On the other hand, a managed service requires users to (1) define the job and (2) define the solution too. The managed service finds the best way to implement your solution. Let's compare the steps required to train a ML model on a traditional cloud service, vs. a managed cloud service.</p> <ul><li><p>Traditional cloud service:</p> <ol><li>User creates a VM in the cloud with the desired hardware configuration.</li> <li>User installs all dependencies and ensures compatibility among the package versions.</li> <li>User trains the model on the VM.</li></ol></li> <li><p>Managed cloud service:</p> <ol><li>User provides the model to ML engine.</li> <li>User provides a configuration file describing the desired hardware infrastructure. The configuration can be a complex cluster with multiple nodes, or a simple single VM.</li> <li>ML engine creates a cohesive optimal environment using the configuration file, installs dependencies, ensure compatibility, and trains the model.</li></ol></li></ul> <p>ML engine provides many pre-built hardware configurations to choose from. For example, a <strong>STANDARD_1</strong> tier configuration has eight VMs of different types working together in a cluster, and a <strong>BASIC_GPU</strong> tier has only one VM with a NVIDIA Tesla K80 GPU, working alone. We can also choose the <strong>CUSTOM</strong> tier and create our own configuration. Here is a <a href="https://cloud.google.com/ml-engine/docs/tensorflow/machine-types" target="_blank" rel="noopener noreferrer">comprehensive list<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of all the tiers and their descriptions.</p> <h2 id="install-google-cloud-sdk"><a href="#install-google-cloud-sdk" aria-hidden="true" class="header-anchor">#</a> Install Google Cloud SDK</h2> <p>We will need the <strong>gcloud</strong> and <strong>gsutil</strong> command line tools. Please install the <a href="https://cloud.google.com/sdk/docs/" target="_blank" rel="noopener noreferrer">Google Cloud SDK<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to acquire them. Once installed, open up a terminal window and run <code>gcloud init</code>. Log in to your Google cloud account and choose the project you created in the previous tutorial, when prompted.</p> <h2 id="make-code-compatible-with-ml-engine"><a href="#make-code-compatible-with-ml-engine" aria-hidden="true" class="header-anchor">#</a> Make code compatible with ML engine</h2> <p>A traditional model training code requires some modifications to make it compatible with ML engine. Let's go through them step-by-step.</p> <ol><li>Make a python file named <strong>train.py</strong> and put all your code in it. If your code is divided among multiple python files, please make sure that <strong>train.py</strong> is the main python file that references code in the other files. This is necessary because ML engine looks for a <strong>train.py</strong> file in your project folder and runs it.</li> <li>Modify your code so that you can pass command line arguments. We will need to pass two arguments: (1) the location of the input data, and (2) the location where summary and checkpoints will be stored. We will pass local machine paths when testing our code locally, but pass cloud storage bucket paths when running our code on the cloud. Here is a sample train.py file format:<div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Import the argparse module</span>
<span class="token keyword">import</span> argparse
<span class="token comment"># Training function</span>
<span class="token keyword">def</span> <span class="token function">train_model</span><span class="token punctuation">(</span>job_dir<span class="token punctuation">,</span> train_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    Put your training code here
    ..
    ..

    '''</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Traning Data Location: &quot;</span> <span class="token operator">+</span> train_data<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Model Saving Location: &quot;</span> <span class="token operator">+</span> job_dir<span class="token punctuation">)</span>
<span class="token comment"># Main</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># Create an argument parser instance</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Add the arguments placeholders</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;--job-dir&quot;</span><span class="token punctuation">,</span>
    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;cloud or local location where summary, checkpoints and model will be saved&quot;</span><span class="token punctuation">,</span>
      required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;--train-data&quot;</span><span class="token punctuation">,</span>
    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;cloud or local location of the input data&quot;</span><span class="token punctuation">,</span>
      required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># Read the arguments</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Put them in variables</span>
    job_dir <span class="token operator">=</span> args<span class="token punctuation">.</span>job_dir
    train_data <span class="token operator">=</span> args<span class="token punctuation">.</span>train_data
    <span class="token comment"># Pass them to training function</span>
    train_model<span class="token punctuation">(</span>job_dir<span class="token punctuation">,</span> train_data<span class="token punctuation">)</span>
</code></pre></div></li> <li>Replace file operations with Tensorflow's python file operations. This step is needed because python's file operations do not work with files stored in Google cloud storage buckets. Here is a sample code to do this:<div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Import the the file_io package </span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>io <span class="token keyword">import</span> file_io
<span class="token comment"># A sample empty text file</span>
sample_file <span class="token operator">=</span> <span class="token string">&quot;sample.txt&quot;</span>
<span class="token comment"># Open a file handle to write</span>
f <span class="token operator">=</span> file_io<span class="token punctuation">.</span>FileIO<span class="token punctuation">(</span>sample_file<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'w'</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">&quot;Hello World\n&quot;</span><span class="token punctuation">)</span>
<span class="token comment"># Open a file handle to read</span>
f <span class="token operator">=</span> file_io<span class="token punctuation">.</span>FileIO<span class="token punctuation">(</span>sample_file<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#PLEASE NOTE: DON'T DO &quot;f.close()&quot;</span>
</code></pre></div></li></ol> <h2 id="create-a-ml-engine-job"><a href="#create-a-ml-engine-job" aria-hidden="true" class="header-anchor">#</a> Create a ML engine job</h2> <p>Now that our code is compatible with ML engine, we need to create a <strong>ML engine job</strong>. Creating a job is basically creating some files and putting them inside a folder. Here are the steps:</p> <ol><li><p>Create a folder and give it a name like <strong>facial_recognition_job_1_0</strong> or <strong>landmark_detection_job_2_1</strong>. For this tutorial, let's say we name it <strong>ml_engine_example</strong>.</p></li> <li><p>Inside <strong>ml_engine_example/</strong>, create a folder called <strong>trainer/</strong>. Move you <strong>train.py</strong> file and other .py files (if any) inside the <strong>trainer/</strong> folder.</p></li> <li><p>In the same directory (<strong>ml_engine_example/trainer/</strong>), create a file named <strong>__init__.py</strong>. Leave this file empty.</p></li> <li><p>Now, using a terminal, <code>cd</code> into <strong>ml_engine_example/</strong> and run your code using the following command to verify that it works after making the modifications.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>python -m trainer.train --train-data<span class="token operator">=</span><span class="token operator">&lt;</span>location of your train data<span class="token operator">&gt;</span> --job-dir<span class="token operator">=</span><span class="token operator">&lt;</span>location where you want to save the model<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>Create another file in the same directory named <strong>config.yaml</strong>. Copy the following code into this file.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">trainingInput</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTier</span><span class="token punctuation">:</span> CUSTOM
  <span class="token key atrule">masterType</span><span class="token punctuation">:</span> standard_gpu
  <span class="token key atrule">runtimeVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;1.8&quot;</span>
  <span class="token key atrule">pythonVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;3.5&quot;</span>
</code></pre></div></li> <li><p>Let's go through the config.yaml file.</p> <ul><li><strong>trainingInput</strong>: As the name suggests, all the parameters that ML engine needs to start a training job, comes under this parameter.</li> <li><strong>scaleTier</strong>: This parameter is for defining the type of architecture. We chose a custom architecture, meaning that we will create our own architecture rather than using a pre-built one. Here is a <a href="https://cloud.google.com/ml-engine/docs/tensorflow/machine-types" target="_blank" rel="noopener noreferrer">comprehensive list<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of all the tiers and their descriptions.</li> <li><strong>masterType</strong>: As we chose the custom tier, we will need to provide more information about the architecture. In a distributed ML architecture, a job is run on a cluster of VMs. These VMs are called nodes. A <strong>master node</strong> or <strong>chief worker node</strong> assigns operations to worker nodes, coordinates these operations and works as a worker node as well. <strong>Worker nodes</strong> calculate gradient vectors from the training dataset. Another kind of node called <strong>parameter server node</strong>, updates parameters with the gradient vectors from the worker nodes. For this example, we will create an architecture with only one node (non- distributed architecture). We selected a node called <strong>standard_gpu</strong> as our master node and we will not have any worker or parameter server nodes. Here is a link to learn more about <a href="https://cloud.google.com/ml-engine/docs/tensorflow/distributed-tensorflow-mnist-cloud-datalab" target="_blank" rel="noopener noreferrer">distributed training on ML engine<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li> <li><strong>runtimeVersion</strong>: This is the ML engine version. Each ML engine version comes with a unique set of packages and package versions. For example, ML engine version 1.0 includes Tensorflow 1.0.1 and a list of  packages essential for data science, such as numpy, scipy, and pandas to name a few. In our case, we will use version 1.8.</li> <li><strong>pythonVersion</strong>: We are using python 3.5. Please check the python version and tensorflow version on your local machine and find the ML engine version that supports both. Here is the <a href="https://cloud.google.com/ml-engine/docs/tensorflow/runtime-version-list" target="_blank" rel="noopener noreferrer">list of runtime versions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for ML engine.</li></ul></li> <li><p>Create a file called <strong>setup.py</strong> in the <strong>ml_engine_example/</strong> directory (not in the <strong>ml_engine_example/trainer/</strong> directory like the other files). This file is used by ML engine to install dependency packages. Go to the <a href="https://cloud.google.com/ml-engine/docs/tensorflow/runtime-version-list" target="_blank" rel="noopener noreferrer">list of runtime versions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to check which packages come with the ML engine version you are using. Any packages not included in this list, must be installed through <strong>setup.py</strong>. Copy this code into your <strong>setup.py</strong> file:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> setuptools <span class="token keyword">import</span> setup<span class="token punctuation">,</span> find_packages

REQUIRED_PACKAGES <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'some_PyPI_package&gt;=1.0'</span><span class="token punctuation">]</span>

setup<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">'trainer'</span><span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">'0.1'</span><span class="token punctuation">,</span>
    install_requires<span class="token operator">=</span>REQUIRED_PACKAGES<span class="token punctuation">,</span>
    packages<span class="token operator">=</span>find_packages<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    include_package_data<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">'My training application package.'</span>
<span class="token punctuation">)</span>
</code></pre></div><p>Any extra packages not included in your ML engine version, can be install through the <strong>install_requires</strong> field. A list of all the dependencies can be passed through this variable. You may write some code to create a list of dependencies prior to the <strong>setup()</strong> function call, or populate the list manually, as in the example above. You can also install custom made packages and packages not available through pip installs. Please read more about <a href="https://cloud.google.com/ml-engine/docs/tensorflow/packaging-trainer" target="_blank" rel="noopener noreferrer">packaging<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> if you want to include custom or non-pip packages.</p></li> <li><p>We have to create one last file. Create a file named <strong>cloud_shell_command.sh</strong> in the <strong>ml_engine_example/</strong> directory and paste the following code:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">export</span> JOB_DIR<span class="token operator">=</span>gs://<span class="token operator">&lt;</span>your bucket name<span class="token operator">&gt;</span>/code/ml_engine_example/model
<span class="token function">export</span> DATA_DIR<span class="token operator">=</span>gs://<span class="token operator">&lt;</span>your bucket name<span class="token operator">&gt;</span>/data/ml_engine_example
<span class="token function">export</span> JOB_NAME<span class="token operator">=</span><span class="token string">&quot;ml_engine_example_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d_%H%M%S<span class="token variable">)</span></span>&quot;</span>
<span class="token function">export</span> REGION<span class="token operator">=</span>us-central1

gcloud ml-engine <span class="token function">jobs</span> submit training <span class="token variable">$JOB_NAME</span> \
  --job-dir <span class="token variable">$JOB_DIR</span> \
  --module-name trainer.train \
  --package-path ./trainer \
  --region <span class="token variable">$REGION</span> \
  --config trainer/config.yaml \
  -- \
  --train-data <span class="token variable">$DATA_DIR</span>/
</code></pre></div></li> <li><p>This file contains a shell command used to submit our job to ML engine. Let's look at these values:</p> <ul><li><strong>JOB_DIR</strong> and <strong>DATA_DIR</strong>: These are the cloud locations where your model will be stored and where your data is stored. We will update the <strong>bucket name</strong> once we create a bucket under the <a href="#uploading-data-and-code-to-the-cloud">Uploading data and code to the cloud</a> section.</li> <li><strong>JOB_NAME</strong>: This is the name of the job followed by the current data and time. ML engine stores logs every time we train. Adding the date and time helps distinguish between these logs.</li> <li><strong>REGION</strong>: This parameter defines the physical location of the cloud resources that will be procured to run your ML engine job. <strong>us-central1</strong> is the closest location to Albuquerque, so all our resources will be created in this region for good performance and cost efficiency.</li> <li><strong>module-name</strong>: This is the directory of your <strong>train.py</strong> file. Inside the job folder (<strong>ml_engine_example/</strong>), the <strong>train.py</strong> file is located at <strong>trainer/train.py</strong>. Hence the value <strong>trainer.train</strong> is used for this parameter.</li> <li><strong>package-path</strong>: This is the path to the <strong>trainer</strong> folder. ML engine treats the <strong>trainer</strong> folder as a package. This is the reason we added a <strong>__init__.py</strong> in this folder.</li></ul> <p>After these steps, your ML job folder should look like this:</p> <div class="language- extra-class"><pre class="language-text"><code>├── ml_engine_example/ 
    ├── trainer/
    │   ├── __init__.py
    │   ├── train.py
    │   └── config.yaml
    ├── cloud_shell_command.sh
    └── setup.py
</code></pre></div></li> <li><p>Now check if your ML engine job was made correctly by running it locally using the gcloud command. In a terminal window, <code>cd</code> into the <strong>ml_engine_example/</strong> folder and run this code:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ gcloud ml-engine local train --module-name trainer.train --package-path ./trainer -- --train-data<span class="token operator">=</span><span class="token operator">&lt;</span>location of your train data<span class="token operator">&gt;</span> --job-dir<span class="token operator">=</span><span class="token operator">&lt;</span>location where you want to save the model<span class="token operator">&gt;</span>
</code></pre></div><p>The first set of arguments are for the ML engine and second set of arguments are for your python code. Note that the two types of arguments are separated by an extra &quot;--&quot;. Also, note that in the local version of the gcloud command, the parameter <strong>--job-dir</strong> belongs to the second set of arguments and in the cloud version of the same command (in <strong>cloud_shell_command.sh</strong> file), it belongs to the first set of arguments.</p></li></ol> <h2 id="uploading-data-and-code-to-the-cloud"><a href="#uploading-data-and-code-to-the-cloud" aria-hidden="true" class="header-anchor">#</a> Uploading data and code to the cloud</h2> <p>Now that your ML engine job is ready, let's move it to the cloud.</p> <ol><li><p>Open your cloud <a href="https://console.cloud.google.com" target="_blank" rel="noopener noreferrer">console<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, click on this button <img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/navigation_menu_button.png" alt="alt text" title="Navigation menu button"> to open the navigation menu and then click on <strong>Storage</strong> to open cloud storage.<br> <img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/storage_button.jpg" alt="alt text" title="Storage button"></p></li> <li><p>Click on <strong>CREATE BUCKET</strong> <img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/create_bucket_button.png" alt="alt text" title="Create bucket button"> , choose a name for your bucket, select <strong>Regional</strong> and click <strong>Create</strong>.</p></li> <li><p>Once the bucket is created, the console displays the contents of your bucket (a message <em>&quot;There are no live objects in this bucket....&quot;</em> is displayed as your bucket is empty). You will see a few buttons such as <strong>Upload files</strong>, <strong>Upload folder</strong> and <strong>Create folder</strong>. Create two folders named <strong>code</strong> and <strong>data</strong> using the <strong>Create folder</strong> button. Now your bucket should look like this:</p> <p><img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/bucket.jpg" alt="alt text" title="Bucket"></p></li> <li><p>Enter the <strong>data/</strong> folder by clicking on it and use the <strong>Create folder</strong> button to create another folder named <strong>ml_engine_example/</strong> inside <strong>data/</strong> folder.</p></li> <li><p>Now enter <strong>ml_engine_example/</strong> folder and click on <strong>Upload files</strong> or <strong>Upload folder</strong> button to upload your training data into <strong>ml_engine_example/</strong> folder.</p></li> <li><p>Next, upload your ML job (the <strong>ml_engine_example/</strong> folder on your local machine that contains all your code) to the <strong>code/</strong> folder in your bucket. Do not forget to update your <strong>bucket name</strong> in <strong>cloud_shell_command.sh</strong> (in <strong>JOB_DIR</strong> and <strong>DATA_DIR</strong> variables) file, before uploading. Now your bucket folder structure should look like this:</p> <div class="language- extra-class"><pre class="language-text"><code>├── your_bucket/
    ├── data/
    │   └── ml_engine_example/ 
    │       └── training data
    └── code/
        ├── ml_engine_example/ 
            ├── trainer/
            │   ├── __init__.py
            │   ├── train.py
            │   └── config.yaml
            ├── cloud_shell_command.sh
            └── setup.py
</code></pre></div></li></ol> <h2 id="cloud-shell"><a href="#cloud-shell" aria-hidden="true" class="header-anchor">#</a> Cloud shell</h2> <p>Although we can access many of the cloud resources from the console UI, some operations can only be performed through the <strong>cloud shell</strong>. Cloud shell is the terminal window of a small linux virtual machine that is connected to all your cloud resources. This means you can access and manipulate all your cloud resources such as your buckets, databases, compute engine instances and ML jobs through cloud shell.</p> <p>To open your cloud shell, click on this <img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/shell_button.png" alt="alt text" title="Shell button"> button present at the top right corner of you GCP console. It takes a few minutes for google cloud to create the virtual machine before you can use the shell. When the shell is ready, your console should look like this:</p> <p><img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/cloud_shell.jpg" alt="alt text" title="Cloud shell"></p> <h2 id="run-your-ml-job"><a href="#run-your-ml-job" aria-hidden="true" class="header-anchor">#</a> Run your ML job</h2> <ol><li><p>Let's start by copying the job onto the disk of the cloud shell machine. Run the code below on the cloud shell window (the black partial window touching the bottom edge of the screen).</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ gsutil <span class="token function">cp</span> -r gs://<span class="token operator">&lt;</span>your bucket name<span class="token operator">&gt;</span>/code/ml_engine_example ~
</code></pre></div><p>Then <code>cd</code> into the job folder you just copied.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cd</span> ml_engine_example/
</code></pre></div><p>Give permission to run <strong>cloud_shell_command.sh</strong>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">chmod</span> +x gcloud_command.sh
</code></pre></div><p>Run <strong>cloud_shell_command.sh</strong> to submit your ML engine job.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./gcloud_command.sh
</code></pre></div><p>On the cloud shell you might get a message asking permission to activate some APIs. Please allow the activation of these APIs. If you get a message on the cloud shell that your job was queued, your job is now running on the ML engine.</p></li> <li><p>Open the navigation menu and click on <strong>ML engine</strong> tab to open the ML engine console. You will see a list of all the ML engine jobs you have run so far. If this is your first time running a job, you will only see one entry.</p> <p><img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/ml_engine_button.jpg" alt="alt text" title="ML engine button"></p></li> <li><p>Click on the <strong>Job ID</strong> to monitor your running job. You can track the activity of all the nodes used in your architecture.</p> <p><img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/ml_job_id.jpg" alt="alt text" title="ML job ID"></p></li> <li><p>Click on <strong>View Logs</strong> to see the steps being taken by ML engine. Once the training starts, your code output will be displayed here as well.</p> <p><img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/logs_button.jpg" alt="alt text" title="Logs button"></p></li> <li><p>If your code is generating tensorflow logs, you can visualize them using tensorboard. On the cloud shell, run this code:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token keyword">echo</span> tensorboard log dir: <span class="token variable">${JOB_DIR}</span>
$ tensorboard --logdir<span class="token operator">=</span><span class="token variable">${JOB_DIR}</span>/logs --port 8000 --reload_interval<span class="token operator">=</span>5
</code></pre></div><p>If running the <code>echo</code> command shows that the <strong>JOB_DIR</strong> environment variable is empty, replace <code>${JOB_DIR}</code> by <code>gs://&lt;your bucket name&gt;/code/ml_engine_example/model</code> in your <code>tensorboard</code> command.</p></li> <li><p>Once the tensorboard is ready for access, click on the <strong>Web preview</strong> button <img src="https://raw.githubusercontent.com/lumi-docs/data/master/google_cloud_platform/web_preview_button.png" alt="alt text" title="Web preview button"> located at the right corner of the cloud shell window (the black partial window touching the bottom edge of the screen), and click on <strong>Change port</strong>. In the popup, enter port number 8000 because tensorflow was run on this port, and click <strong>CHANGE AND PREVIEW</strong>.</p></li></ol> <h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>In this tutorial, we learnt more about ML engine. We saw how to convert a model into a ML job and train it on ML engine. We also learned how to upload data into buckets and had an introduction to cloud shell. In the next tutorial we will see, how to draw predictions from our trained model.</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/docs/google_cloud_platform/setting_up_your_console/" class="prev">
          Setting up your console
        </a></span> <span class="next"><a href="/docs/m_series_json_data/">
          M series JSON data
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.12f85102.js" defer></script><script src="/assets/js/6.fd7790cd.js" defer></script>
  </body>
</html>
